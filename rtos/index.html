<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="FujiHack Contributors">
        <link rel="canonical" href="https://wiki.fujihack.org/rtos/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Firmware overview - FujiHack Wiki</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <link href="../a.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">FujiHack Wiki</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Fujifilm Internals <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../history/" class="dropdown-item">History overview</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Firmware overview</a>
</li>
                                    
<li>
    <a href="../autoactscr/" class="dropdown-item">AUTO ACT script</a>
</li>
                                    
<li>
    <a href="../keys/" class="dropdown-item">Key codes</a>
</li>
                                    
<li>
    <a href="../tasks/" class="dropdown-item">Tasks</a>
</li>
                                    
<li>
    <a href="../ptp/" class="dropdown-item">PTP/USB</a>
</li>
                                    
<li>
    <a href="../syslog/" class="dropdown-item">Syslog</a>
</li>
                                    
<li>
    <a href="../signatures/" class="dropdown-item">Function signatures</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Development <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../words/" class="dropdown-item">Vocabulary</a>
</li>
                                    
<li>
    <a href="../structure/" class="dropdown-item">Project Structure</a>
</li>
                                    
<li>
    <a href="../todo/" class="dropdown-item">Help Needed</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../history/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../autoactscr/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/fujihack/fujihack.github.io" class="nav-link"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#technical-overview-of-fujifilms-firmware" class="nav-link">Technical overview of Fujifilm's Firmware</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#fujifilms-io-api" class="nav-link">Fujifilm's I/O API</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#memory-management" class="nav-link">Memory management</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#performance" class="nav-link">Performance</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#graphics" class="nav-link">Graphics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="technical-overview-of-fujifilms-firmware">Technical overview of Fujifilm's Firmware</h2>
<p>(These details come from reverse-engineering the firmware of the X-A2.)</p>
<p>Fujifilm started working on their firmware in the early 2000s. Instead of writing their firmware directly on an RTOS,
they made a <em>compatibility layer</em> over an existing RTOS. This allowed them to easily switch from VxWorks to NORTi and
to ThreadX over the years. Each function in Fuji's compatibility layer calls a specific index of a function table, which
makes reverse engineering or using the underlying RTOS very difficult. Instead, this project aims to reverse engineer only
Fujifilm's compatibility layer instead.</p>
<h2 id="fujifilms-io-api">Fujifilm's I/O API</h2>
<ul>
<li>See <a href="https://github.com/fujihack/fujihack/blob/master/src/ff_io.h">ff_io.h</a></li>
</ul>
<h2 id="memory-management">Memory management</h2>
<p>Unlike most firmware, Fujifilm doesn't have a <code>malloc()</code> function. Each task works with fixed empty arrays. The developers
created <em>huge</em> global variables. This means a lot of RAM is wasted, and it makes it harder to load Fujihack. There are some allocation functions,
such as the ones from SQLite or the WiFi code, but these only offer a megabyte or two and don't take advantage of all the RAM the camera has (1GB).</p>
<p>This unusual memory management has both pros and cons for the Fujihack project.
- Patching data is easier - since everything is a global variable, a fixed address can be used to specify any data
- It's hard to load a large Fujihack binary - Since memory can't be easily allocated, this makes it hard to find space to load Fujihack.</p>
<p>Overall, it's not a deal breaker. Fujifilm managed to make it work over the years, and Fujihack can find ways around it.</p>
<h2 id="performance">Performance</h2>
<p>Fujifilm cameras up to 2016 are really slow. The CPU is underclocked to preserve battery life, which makes the camera sluggish sometimes. This doesn't
take a toll on things like JPEG encoding and decoding, because it's done through hardware.</p>
<p>The CPU performance of the X-A2 is similar to an i386 desktop computer of the mid 90s.</p>
<p>After 2016, Fujifilm did <em>something</em> that improved performance. Or, at least the menu performance.</p>
<h2 id="graphics">Graphics</h2>
<ul>
<li>Vector graphics processing is handled on vglib task</li>
<li>Most cameras use OpenVG with the <code>VG_KHR_EGL_image</code> plugin. Implemented into Fuji cameras by <a href="https://www.nec.com/">NEC Systems Technology Ltd</a> in the 2000s.</li>
<li>The rst task renders the OpenVG objects (?)</li>
<li>Cameras since ~2017 use a very limited OpenGL to better render graphics and menus.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
